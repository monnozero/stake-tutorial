This is a [Next.js](https://nextjs.org/) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/basic-features/font-optimization) to automatically optimize and load Inter, a custom Google Font.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js/) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/deployment) for more details.


# Create a Nextjs Project with useDapp

## Thiết lập một dự án Front-end mới:

```
npx create-next-app@14.2.5
cd frontend
npm i @chakra-ui/react @chakra-ui/next-js @emotion/react @emotion/styled framer-motion @heroicons/react @chakra-ui/icons react-toastify react-use
npm i dedot @dedot/chaintypes@0.10.0 @polkadot/extension-inject@0.51.1
```
## After installing Chakra UI, you need to set up the ChakraProvider 

 - Setup Provider `frontend/src/providers` add a `ChakraProvider.tsx`

 ```
'use client';

import { CacheProvider } from '@chakra-ui/next-js';
import { ChakraProvider } from '@chakra-ui/react';

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <CacheProvider>
      <ChakraProvider>{children}</ChakraProvider>
    </CacheProvider>
  );
}
 ```

 - Setup Layout `frontend/src/app/layout.tsx` use the Providers component in your layouts.

 ```
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { Providers as UiProvider  } from "@/providers/ChakraProvider";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <UiProvider>{children}</UiProvider>
      </body>
    </html>
  );
}

 ```

## After you need to set up the Wallet provider

- Create `Wallet.ts` from `src/wallets/Wallet.ts`

```
import { InjectedWindow } from '@polkadot/extension-inject/types';

export interface WalletOptions {
  id: string;
  name: string;
  logo: string;
}

abstract class Wallet<Options extends WalletOptions = WalletOptions> {
  #options: Options;

  constructor(options: Options) {
    this.#options = options;
  }

  get id() {
    return this.#options.id;
  }

  get name() {
    return this.#options.name;
  }

  get logo() {
    return this.#options.logo;
  }

  get options() {
    return this.#options;
  }

  get version() {
    return this.injectedProvider?.version;
  }

  get injectedWeb3() {
    const injectedWindow = window as Window & InjectedWindow;

    if (!injectedWindow.injectedWeb3) {
      injectedWindow.injectedWeb3 = {};
    }

    return injectedWindow.injectedWeb3;
  }

  get injectedProvider() {
    return this.injectedWeb3[this.id];
  }

  get ready() {
    return !!this.injectedProvider;
  }

  get installed() {
    return false;
  }

  async initialize() {
    // To implement in subclass
  }

  async waitUntilReady() {
    return new Promise<void>((resolve) => {
      if (this.ready) {
        resolve();
        return;
      }

      const interval = setInterval(() => {
        if (this.ready) {
          clearInterval(interval);
          resolve();
        }
      }, 10);
    });
  }
}

export default Wallet;


```


- Create `type.ts` from `src/types.ts`

```
import { ReactNode } from 'react';

export interface Props {
  className?: string;
  children?: ReactNode;

  [prop: string]: any;
}

export interface NetworkInfo {
  id: string;
  name: string;
  logo: string;
  provider: string;
  prefix: number;
  symbol: string;
  decimals: number;
  subscanUrl?: string;
  chainSpecFileName?: string;
  faucetUrl?: string;
}

export type KeypairType = 'ed25519' | 'sr25519' | 'ecdsa' | 'ethereum';

export interface InjectedAccount {
  address: string;
  genesisHash?: string | null;
  name?: string;
  type?: KeypairType;
}

export type Pop<T extends any[]> = T extends [...infer U, any] ? U : never;
export type Args<T> = T extends [] ? { args?: [] | undefined } : { args: T };
export type OmitNever<T> = { [K in keyof T as T[K] extends never ? never : K]: T[K] };

```

- Create hook `useWallets.ts` from `src/hooks/useWallets.ts`

```
import { useState } from 'react';
import { useEffectOnce } from 'react-use';
import ExtensionWallet from '@/wallets/ExtensionWallet';
import Wallet from '@/wallets/Wallet';

const A_WALLETS: Wallet[] = [
  new ExtensionWallet({
    name: 'SubWallet',
    id: 'subwallet-js',
    logo: '/subwallet-logo.svg',
    installUrl: '',
  }),
  new ExtensionWallet({
    name: 'Talisman',
    id: 'talisman',
    logo: '/talisman-logo.svg',
    installUrl: '',
  }),
  new ExtensionWallet({
    name: 'Polkadot{.js}',
    id: 'polkadot-js',
    logo: '/polkadot-js-logo.svg',
    installUrl: '',
  }),
];

export default function useWallets(): Wallet[] {
  const [wallets, setWallets] = useState<Wallet[]>(A_WALLETS);

  useEffectOnce(() => {
    for (let wallet of wallets) {
      wallet
        .initialize()
        .then(() => {
          setWallets([...wallets]);
        })
        .catch(() => {
          // TODO: handle error here!
        });
    }
  });

  return wallets;
}

```

- Create `WalletProvider.tsx` from `src/providers/WalletProvider.tsx`

```
'use client'
import { createContext, useContext, useState } from 'react';
import { toast } from 'react-toastify';
import { useAsync, useLocalStorage } from 'react-use';
import { Injected } from '@polkadot/extension-inject/types';
import useWallets from '@/hooks/useWallets';
import { InjectedAccount, Props } from '@/types';
import Wallet from '@/wallets/Wallet';

interface WalletContextProps {
  accounts: InjectedAccount[];
  injectedApi?: Injected;
  enableWallet: (id: string) => void;
  signOut: () => void;
  availableWallets: Wallet[];
  connectedWalletId?: string;
  connectedWallet?: Wallet;
  selectedAccount?: InjectedAccount;
  setSelectedAccount: (account: InjectedAccount) => void;
}

export const WalletContext = createContext<WalletContextProps>({
  accounts: [],
  enableWallet: () => {},
  signOut: () => {},
  availableWallets: [],
  setSelectedAccount: () => {},
});

export const useWalletContext = () => {
  return useContext(WalletContext);
};

export default function WalletProvider({ children }: Props) {
  const availableWallets = useWallets();
  const [accounts, setAccounts] = useState<InjectedAccount[]>([]);
  const [injectedApi, setInjectedApi] = useState<Injected>();
  const [connectedWalletId, setConnectedWalletId, removeConnectedWalletId] =
    useLocalStorage<string>('CONNECTED_WALLET');
  const [connectedWallet, setConnectedWallet] = useState<Wallet>();
  const [selectedAccount, setSelectedAccount, removeSelectedAccount] =
    useLocalStorage<InjectedAccount>('SELECTED_ACCOUNT');

  const getWallet = (id: string): Wallet => {
    const targetWallet: Wallet = availableWallets.find((one) => one.id === id)!;
    if (!targetWallet) {
      throw new Error('Invalid Wallet ID');
    }

    return targetWallet;
  };

  useAsync(async () => {
    if (!connectedWalletId) {
      setConnectedWallet(undefined);
      return;
    }

    let unsub: () => void;
    try {
      const targetWallet: Wallet = getWallet(connectedWalletId);
      setConnectedWallet(targetWallet);

      await targetWallet.waitUntilReady();

      const injectedProvider = targetWallet.injectedProvider;
      if (!injectedProvider?.enable) {
        throw new Error('Wallet is not existed!');
      }

      const injectedApi = await injectedProvider.enable('Sample Dapp');

      unsub = injectedApi.accounts.subscribe(setAccounts);

      setInjectedApi(injectedApi);
    } catch (e: any) {
      toast.error(e.message);
      setConnectedWallet(undefined);
      removeConnectedWalletId();
    }

    return () => unsub && unsub();
  }, [connectedWalletId]);

  const enableWallet = async (walletId: string) => {
    setConnectedWalletId(walletId);
  };

  const signOut = () => {
    removeConnectedWalletId();
    setInjectedApi(undefined);
    removeSelectedAccount();
  };

  return (
    <WalletContext.Provider
      value={{
        accounts,
        enableWallet,
        injectedApi,
        signOut,
        availableWallets,
        connectedWalletId,
        connectedWallet,
        selectedAccount,
        setSelectedAccount,
      }}>
      {children}
    </WalletContext.Provider>
  );
}

```

 - Setup Layout `frontend/src/app/layout.tsx` use the Providers component in your layouts.

 ```
 import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { Providers as UiProvider  } from "@/providers/ChakraProvider";
import WalletProvider from "@/providers/WalletProvider";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <UiProvider>
          <WalletProvider>
            {children}
          </WalletProvider>
        </UiProvider>
      </body>
    </html>
  );
}

 ```

Create `ApiProvider.tsx` from `src/providers/ApiProvider.tsx`

```
'use client'
import { createContext, useContext, useEffect } from 'react';
import { useLocalStorage } from 'react-use';
import useApi from '@/hooks/useApi';
import { useWalletContext } from '@/providers/WalletProvider';
import { NetworkInfo, Props } from '@/types';
import { SUPPORTED_NETWORKS } from '@/utils/networks';
import { DedotClient } from 'dedot';

interface ApiContextProps {
  api?: DedotClient;
  apiReady: boolean;
  network: NetworkInfo;
  setNetwork: (one: NetworkInfo) => void;
  defaultCaller: string;
}

const DEFAULT_NETWORK = SUPPORTED_NETWORKS['pop_network'];
const DEFAULT_CALLER = '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY'; // Alice

export const ApiContext = createContext<ApiContextProps>({
  apiReady: false,
  network: DEFAULT_NETWORK,
  setNetwork: () => {},
  defaultCaller: DEFAULT_CALLER,
});

export const useApiContext = () => {
  return useContext(ApiContext);
};

export default function ApiProvider({ children }: Props) {
  const { injectedApi } = useWalletContext();
  const [network, setNetwork] = useLocalStorage<NetworkInfo>('SELECTED_NETWORK', DEFAULT_NETWORK);
  const { ready, api } = useApi(network);

  useEffect(() => {
    api?.setSigner(injectedApi?.signer);
   
  }, [injectedApi, api]);

  return (
    <ApiContext.Provider
      value={{ api, apiReady: ready, network: network!, setNetwork, defaultCaller: DEFAULT_CALLER }}>
      {children}
    </ApiContext.Provider>
  );
}
```

- Setup ApiProvider `frontend/src/app/layout.tsx` use the Providers component in your layouts.

```
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { Providers as UiProvider } from "@/providers/ChakraProvider";
import WalletProvider from "@/providers/WalletProvider";
import ApiProvider from "@/providers/ApiProvider";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <UiProvider>
          <WalletProvider>
            <ApiProvider>{children}</ApiProvider>
          </WalletProvider>
        </UiProvider>
      </body>
    </html>
  );
}

```

# Connect Wallet and Network

- Create `WalletSelection.tsx` from `src/components/WalletSelection.tsx`

```
'use client'
import {
  Button,
  ChakraProps,
  MenuItem,
  Modal,
  ModalBody,
  ModalCloseButton,
  ModalContent,
  ModalHeader,
  ModalOverlay,
  Stack,
  useDisclosure,
} from "@chakra-ui/react";
import { useWalletContext } from "@/providers/WalletProvider";
import Wallet from "@/wallets/Wallet";
import { ThemingProps } from "@chakra-ui/system";
import Image from "next/image";

interface WalletButtonProps {
  walletInfo: Wallet;
  afterSelectWallet?: () => void;
}

const WalletButton = ({ walletInfo, afterSelectWallet }: WalletButtonProps) => {
  const { name, id, logo, ready, installed } = walletInfo;
  const { enableWallet } = useWalletContext();

  const connectWallet = () => {
    enableWallet(id);

    afterSelectWallet && afterSelectWallet();
  };

  return (
    <Button
      onClick={connectWallet}
      isLoading={installed && !ready}
      isDisabled={!installed}
      loadingText={name}
      size="lg"
      width="full"
      justifyContent="flex-start"
      alignItems="center"
      gap={4}
    >
      {/* <Image src={logo} alt={`${name}`} width={24} height={24} /> */}
      <span>{name}</span>
    </Button>
  );
};

export enum ButtonStyle {
  BUTTON,
  MENU_ITEM,
}

interface WalletSelectionProps {
  buttonStyle?: ButtonStyle;
  buttonLabel?: string;
  buttonProps?: ChakraProps & ThemingProps<"Button">;
}

export default function WalletSelection({
  buttonStyle = ButtonStyle.BUTTON,
  buttonLabel = "Connect Wallet",
  buttonProps,
}: WalletSelectionProps) {
  const { isOpen, onOpen, onClose } = useDisclosure();
  const { availableWallets } = useWalletContext();

  return (
    <>
      {buttonStyle === ButtonStyle.MENU_ITEM && (
        <MenuItem
          
          onClick={onOpen}
          {...buttonProps}
        >
          {buttonLabel}
        </MenuItem>
      )}
      {buttonStyle === ButtonStyle.BUTTON && (
        <Button
          backgroundColor={"#89d7e9"}
          rounded={"full"}
          _hover={{
            shadow: "md",
            backgroundColor: "#C8F5FF",
          }}
          size="md"
          variant="outline"
          onClick={onOpen}
          {...buttonProps}
        >
          {buttonLabel}
        </Button>
      )}

      <Modal onClose={onClose} size="sm" isOpen={isOpen}>
        <ModalOverlay />
        <ModalContent>
          <ModalHeader>Select Wallet to Connect</ModalHeader>
          <ModalCloseButton />
          <ModalBody mb={4}>
            <Stack>
              {availableWallets.map((one) => (
                <WalletButton
                  key={one.id}
                  walletInfo={one}
                  afterSelectWallet={onClose}
                />
              ))}
            </Stack>
          </ModalBody>
        </ModalContent>
      </Modal>
    </>
  );
}
```

- Create `ConnectedWallet.tsx` from `src/components/ConnectedWallet.tsx`

```
import { Flex, Text } from '@chakra-ui/react';
import React from 'react';
import { useWalletContext } from '@/providers/WalletProvider';
import Image from 'next/image';

export default function ConnectedWallet() {
  const { connectedWallet } = useWalletContext();

  return (
    <Flex align='center' gap={3} flex={1} justify='center' pb={2}>
      <Image src={connectedWallet?.logo || ''} alt={connectedWallet?.name || ''} width={24} height={24}/>
      <Text fontWeight='600' fontSize='14'>
        {connectedWallet?.name} - v{connectedWallet?.version}
      </Text>
    </Flex>
  );
}

```

- Create `AccountSelection.tsx` from `src/components/AccountSelection.tsx`

```
'use client'
import { Box, Button, Flex, Menu, MenuButton, MenuDivider, MenuItem, MenuList, Text } from '@chakra-ui/react';
import { useEffect, useMemo } from 'react';
import ConnectedWallet from '@/components/ConnectedWallet';
import WalletSelection, { ButtonStyle } from '@/components/WalletSelection';
import useBalances from '@/hooks/useBalances';
import useDisplayAddress from '@/hooks/useDisplayAddress';
import { useApiContext } from '@/providers/ApiProvider';
import { useWalletContext } from '@/providers/WalletProvider';
import { formatBalance, shortenAddress } from '@/utils/string';
import { ChevronDownIcon } from '@chakra-ui/icons';
import Image from 'next/image';

export default function AccountSelection() {
  const { accounts, injectedApi, selectedAccount, setSelectedAccount, signOut, connectedWallet } = useWalletContext();
  const { network } = useApiContext();
  const addresses = useMemo(() => accounts.map((a) => a.address), [accounts]);
  const balances = useBalances(addresses);

  const displayAddress = useDisplayAddress(selectedAccount?.address);

  useEffect(() => {
    if (selectedAccount && accounts.map((one) => one.address).includes(selectedAccount.address)) {
      return;
    }

    setSelectedAccount(accounts[0]);
  }, [accounts, selectedAccount, setSelectedAccount]);

  if (!selectedAccount) {
    return <></>;
  }

  const { name, address } = selectedAccount;

  return (
    <Box >
      <Menu autoSelect={false}>
        <MenuButton as={Button} backgroundColor={'#89d7e9'} rounded={'full'}   _hover={{
              shadow: "md",
              backgroundColor: "#C8F5FF",
            }}>
          <Flex align='center' gap={2}>
            
            <Text fontSize='sm' fontWeight='500' textColor={"#026262"}>
              {shortenAddress(displayAddress)}
            </Text>
            <ChevronDownIcon fontSize='xl' />
          </Flex>
        </MenuButton>

        <MenuList>
          <ConnectedWallet />

          {accounts.map((one) => (
            <MenuItem
              backgroundColor={one.address === address ? 'gray.200' : ''}
              gap={2}
              key={one.address}
              onClick={() => setSelectedAccount(one)}>
              <Flex direction='column'>
                <Text fontWeight='500'>{one.name}</Text>

                <Text fontSize='xs'>Address: {shortenAddress(one.address)}</Text>
                <Text fontSize='xs'>
                  Balance: {formatBalance(balances[one.address]?.free) || '0'} {network.symbol}
                </Text>
              </Flex>
            </MenuItem>
          ))}
          <MenuDivider />
          <WalletSelection
            buttonStyle={ButtonStyle.MENU_ITEM}
            buttonLabel='Switch Wallet'
            buttonProps={{ color: 'primary.500' }}
          />
          <MenuItem onClick={signOut} color='red.500'>
            Sign Out
          </MenuItem>
        </MenuList>
      </Menu>
    </Box>
  );
}

```

- Create `NetworkSelection.tsx` from `src/components/NetworkSelection.tsx`

```
'use client'
import { Box, Button, Flex, Menu, MenuButton, MenuItem, MenuList, Spinner } from '@chakra-ui/react';
import { useApiContext } from '@/providers/ApiProvider';
import { SUPPORTED_NETWORKS } from '@/utils/networks';
import Image from 'next/image';

function NetworkStatusIndicator() {
  const { apiReady } = useApiContext();

  if (apiReady) {
    return <Box borderRadius='50%' width={3} height={3} backgroundColor='green.500' />;
  } else {
    return <Spinner size='xs' />;
  }
}

export default function NetworkSelection() {
  const { network, setNetwork } = useApiContext();


  return (
    <Menu autoSelect={false} >
      <MenuButton as={Button} flexShrink={0} backgroundColor={'#89d7e9'} rounded={'full'}   _hover={{
              shadow: "md",
              backgroundColor: "#C8F5FF",
            }}>
        <Flex direction='row' align='center' gap={2} >
          <Image src={network.logo} alt={network.name} width={22} height={22} style={{ borderRadius: 4 }} />
          <Box flexShrink={0}>
            <NetworkStatusIndicator />
          </Box>
        </Flex>
      </MenuButton>
      <MenuList>
        {Object.values(SUPPORTED_NETWORKS).map((one) => (
          <MenuItem
            key={one.id}
            onClick={() => setNetwork(one)}
            backgroundColor={one.id === network.id ? 'gray.200' : ''}>
            <Flex direction='row' align='center' gap={2}>
              <span>{one.name}</span>
            </Flex>
          </MenuItem>
        ))}
      </MenuList>
    </Menu>
  );
}

```
- Create `MainHeader` from `src/components/MainHeader/index.tsx`

`
"use client";
import { Box, Container, Flex, Text } from "@chakra-ui/react";
import React from "react";
import AccountSelection from "@/components/AccountSelection";

import { useWalletContext } from "@/providers/WalletProvider";
import NetworkSelection from "@/components/NetworkSelection";
import WalletSelection from "@/components/WalletSelection";
import MenuNavigate from "@/components/MainHeader/MenuNavigate";


export default function MainHeader() {
  const { injectedApi } = useWalletContext();

  return (
    <Box borderBottom={1} borderStyle="solid" borderColor="gray.200">
      <Container
        maxWidth="full"
        px={4}
        mx="auto"
        display="flex"
        justifyContent="space-between"
        alignItems="center"
        gap={4}
        h={16}
      >
        <MenuNavigate/>
        <Flex gap={2}>
        <NetworkSelection />

          {injectedApi ? <AccountSelection /> : <WalletSelection />}
         
        </Flex>
      </Container>
    </Box>
  );
}
`


- Add MainHeader `frontend/src/app/layout.tsx` use the `MainHeader.tsx` component in your layouts.
```
"use client";
import { Box, Container, Flex, Text } from "@chakra-ui/react";
import React from "react";
import AccountSelection from "@/components/AccountSelection";
import { useWalletContext } from "@/providers/WalletProvider";
import NetworkSelection from "@/components/NetworkSelection";
import WalletSelection from "@/components/WalletSelection";



export default function MainHeader() {
  const { injectedApi } = useWalletContext();

  return (
    <Box borderBottom={1} borderStyle="solid" borderColor="gray.200">
      <Container
        maxWidth="full"
        px={4}
        mx="auto"
        display="flex"
        justifyContent="space-between"
        alignItems="center"
        gap={4}
        h={16}
      >
        <Flex gap={2}>
        <NetworkSelection />

          {injectedApi ? <AccountSelection /> : <WalletSelection />}
         
        </Flex>
      </Container>
    </Box>
  );
}

```